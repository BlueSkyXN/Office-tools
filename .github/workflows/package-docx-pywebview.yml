name: Package docx-toolbox (pywebview)

on:
  workflow_dispatch:
  push:
    branches: [main, dev]
    paths:
      - "docx-toolbox/core/**"
      - "docx-toolbox/pyproject.toml"
      - "docx-toolbox/pywebview/**"
      - ".github/workflows/package-docx-pywebview.yml"
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  lint_and_tests:
    name: Lint and tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: docx-toolbox
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: python -m pytest tests -q

  package:
    name: Package pywebview on ${{ matrix.os }}
    needs: lint_and_tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-15, windows-2022]
    defaults:
      run:
        working-directory: docx-toolbox
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[pywebview,dev]"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: docx-toolbox/pywebview/frontend/package-lock.json

      - name: Build pywebview frontend
        working-directory: docx-toolbox/pywebview/frontend
        run: |
          npm ci
          npm run build

      - name: Resolve artifact version
        id: version
        shell: bash
        run: |
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            echo "value=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            echo "value=dev-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          fi

      - name: Package desktop app
        run: |
          python scripts/package_app.py \
            --app pywebview \
            --version "${{ steps.version.outputs.value }}" \
            --output-dir artifacts

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pywebview-${{ runner.os }}-${{ runner.arch }}-${{ steps.version.outputs.value }}
          path: docx-toolbox/artifacts/*.zip
          if-no-files-found: error
