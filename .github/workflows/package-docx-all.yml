name: Package docx-toolbox (all)

on:
  workflow_dispatch:
  push:

permissions:
  contents: read

jobs:
  lint_and_tests:
    name: Lint and tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: docx-toolbox
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: python -m pytest tests -q

  package:
    name: Package all apps on ${{ matrix.os }}
    needs: lint_and_tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-15, windows-2019]
    defaults:
      run:
        working-directory: docx-toolbox
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[pyside6,pyqt6,flet,pywebview,dev]"

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: docx-toolbox/pywebview/frontend/package-lock.json

      - name: Build pywebview frontend
        working-directory: docx-toolbox/pywebview/frontend
        run: |
          npm ci
          npm run build

      - name: Resolve artifact version
        id: version
        run: |
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            echo "value=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            echo "value=dev-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          fi

      - name: Package all desktop apps
        run: |
          set -euo pipefail
          for app in tk flet pyqt6 pyside6 pywebview; do
            python scripts/package_app.py \
              --app "$app" \
              --version "${{ steps.version.outputs.value }}" \
              --output-dir artifacts
          done
          ls -lah artifacts

      - name: Upload bundled artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-${{ runner.os }}-${{ runner.arch }}-${{ steps.version.outputs.value }}
          path: docx-toolbox/artifacts/*.zip
          if-no-files-found: error
