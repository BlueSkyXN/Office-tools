name: Package docx-toolbox (tk)

on:
  workflow_dispatch:
  push:
    branches: [main, dev]
    paths:
      - "docx-toolbox/core/**"
      - "docx-toolbox/tk/**"
      - ".github/workflows/package-docx-tk.yml"
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  lint_and_tests:
    name: Lint and tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: docx-toolbox
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: python -m pytest tests -q

  package:
    name: Package tk on ${{ matrix.os }}
    needs: lint_and_tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-15, windows-2019]
    defaults:
      run:
        working-directory: docx-toolbox
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Resolve artifact version
        id: version
        shell: bash
        run: |
          if [[ "${GITHUB_REF_TYPE:-}" == "tag" ]]; then
            echo "value=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            echo "value=dev-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          fi

      - name: Package desktop app
        run: |
          python scripts/package_app.py \
            --app tk \
            --version "${{ steps.version.outputs.value }}" \
            --output-dir artifacts

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tk-${{ runner.os }}-${{ runner.arch }}-${{ steps.version.outputs.value }}
          path: docx-toolbox/artifacts/*.zip
          if-no-files-found: error
